<!DOCTYPE html>
<html>
<head>
  <title>Heatmap Data</title>
</head>
<body>
  <table border="1">
    <tr>
      <th>Section</th>
      <th>Overall Avg (s)</th>
      <th>Overall Median (s)</th>
      <th>Non-Clickers Avg (s)</th>
      <th>Non-Clickers Median (s)</th>
      <th>Clickers Avg (s)</th>
      <th>Clickers Median (s)</th>
    </tr>
    <tr>
      <td>hero</td>
      <td>${(data.overall.hero?.avg || 0).toFixed(2)}</td>
      <td>${(data.overall.hero?.median || 0).toFixed(2)}</td>
      <td>${(data.nonClickers.hero?.avg || 0).toFixed(2)} ${(data.nonClickers.hero || Object.keys(data.nonClickers).length === 0) ? '' : '(Possible click misclassification)'}</td>
      <td>${(data.nonClickers.hero?.median || 0).toFixed(2)} ${(data.nonClickers.hero || Object.keys(data.nonClickers).length === 0) ? '' : '(Possible click misclassification)'}</td>
      <td>${(data.clickers.hero?.avg || 0).toFixed(2)}</td>
      <td>${(data.clickers.hero?.median || 0).toFixed(2)}</td>
    </tr>
    <tr>
      <td>middle</td>
      <td>${(data.overall.middle?.avg || 0).toFixed(2)}</td>
      <td>${(data.overall.middle?.median || 0).toFixed(2)}</td>
      <td>${(data.nonClickers.middle?.avg || 0).toFixed(2)} ${(data.nonClickers.middle || Object.keys(data.nonClickers).length === 0) ? '' : '(Possible click misclassification)'}</td>
      <td>${(data.nonClickers.middle?.median || 0).toFixed(2)} ${(data.nonClickers.middle || Object.keys(data.nonClickers).length === 0) ? '' : '(Possible click misclassification)'}</td>
      <td>${(data.clickers.middle?.avg || 0).toFixed(2)}</td>
      <td>${(data.clickers.middle?.median || 0).toFixed(2)}</td>
    </tr>
    <tr>
      <td>bottom</td>
      <td>${(data.overall.bottom?.avg || 0).toFixed(2)}</td>
      <td>${(data.overall.bottom?.median || 0).toFixed(2)}</td>
      <td>${(data.nonClickers.bottom?.avg || 0).toFixed(2)} ${(data.nonClickers.bottom || Object.keys(data.nonClickers).length === 0) ? '' : '(Possible click misclassification)'}</td>
      <td>${(data.nonClickers.bottom?.median || 0).toFixed(2)} ${(data.nonClickers.bottom || Object.keys(data.nonClickers).length === 0) ? '' : '(Possible click misclassification)'}</td>
      <td>${(data.clickers.bottom?.avg || 0).toFixed(2)}</td>
      <td>${(data.clickers.bottom?.median || 0).toFixed(2)}</td>
    </tr>
    <tr>
      <td>unknown</td>
      <td>${(data.overall.unknown?.avg || 0).toFixed(2)}</td>
      <td>${(data.overall.unknown?.median || 0).toFixed(2)}</td>
      <td>${(data.nonClickers.unknown?.avg || 0).toFixed(2)} ${(data.nonClickers.unknown || Object.keys(data.nonClickers).length === 0) ? '' : '(Possible click misclassification)'}</td>
      <td>${(data.nonClickers.unknown?.median || 0).toFixed(2)} ${(data.nonClickers.unknown || Object.keys(data.nonClickers).length === 0) ? '' : '(Possible click misclassification)'}</td>
      <td>${(data.clickers.unknown?.avg || 0).toFixed(2)}</td>
      <td>${(data.clickers.unknown?.median || 0).toFixed(2)}</td>
    </tr>
  </table>
  <script>
    // Track clicks and scrolls
    let lastScrollTime = null;
    let lastClickPosition = { x: 0, y: 0 };
    function getCurrentSection() {
      const sections = document.querySelectorAll('section');
      for (let section of sections) {
        const rect = section.getBoundingClientRect();
        if (rect.top >= 0 && rect.top < window.innerHeight) {
          return section.id || 'unknown';
        }
      }
      return 'unknown';
    }
    function calculateScrollDuration() {
      const now = Date.now();
      const duration = lastScrollTime ? (now - lastScrollTime) / 1000 : 0;
      lastScrollTime = now;
      return duration;
    }

    // Initialize session ID
    const sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2);
    const script = document.createElement('script');
    script.setAttribute('data-session-id', sessionId);
    document.head.appendChild(script);

    // Queue for click events to send on unload
    const clickQueue = [];

    // Only run tracking in the top frame
    if (window.top === window.self) {
      console.log('Running in top frame');

      // Set up MutationObserver with validation
      function setupObserver() {
        const target = document.body;
        if (!target || !(target instanceof Node)) {
          console.error('Cannot set up observer: document.body is invalid', target);
          return;
        }
        const observer = new MutationObserver((mutations) => {
          console.log('Mutation detected, checking links');
          target.querySelectorAll('a[href], button').forEach(element => {
            if (!element.dataset.tracked) {
              element.addEventListener('click', (e) => {
                console.log('Link clicked:', e.target.href || e.target);
                lastClickPosition = { x: e.clientX, y: e.clientY };
                const clickData = {
                  sessionId: sessionId,
                  x: e.clientX,
                  y: e.clientY,
                  page: window.location.href,
                  platform: 'clickfunnels',
                  type: 'click',
                  section: getCurrentSection(),
                  duration: null,
                  target: e.target.tagName.toLowerCase()
                };
                clickQueue.push(clickData);
                fetch('/track', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(clickData),
                  keepalive: true
                });
              });
              element.dataset.tracked = 'true';
            }
          });
        });
        observer.observe(target, { childList: true, subtree: true });
        console.log('Observer successfully set up on document.body');
      }

      // Initialize observer when DOM is ready
      if (document.readyState === 'complete' || document.readyState === 'interactive') {
        setupObserver();
      } else {
        document.addEventListener('DOMContentLoaded', setupObserver);
      }

      // Fallback: Capture clicks via pointerdown
      document.addEventListener('pointerdown', (e) => {
        console.log('Pointer down at:', e.clientX, e.clientY);
        lastClickPosition = { x: e.clientX, y: e.clientY };
      });

      // Scroll tracking
      document.addEventListener('scroll', () => {
        const section = getCurrentSection();
        fetch('/track', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            sessionId: sessionId,
            x: window.innerWidth / 2,
            y: window.scrollY + window.innerHeight / 2,
            page: window.location.href,
            platform: 'clickfunnels',
            type: 'scroll',
            section: section,
            duration: calculateScrollDuration()
          })
        });
      });

      // Send queued clicks on unload
      window.addEventListener('unload', () => {
        if (clickQueue.length > 0) {
          clickQueue.forEach(click => {
            fetch('/track', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(click),
              keepalive: true
            });
          });
        }
      });
    } else {
      console.log('Script running in iframe, skipping tracking setup');
    }

    // Fetch and display data (unchanged)
    fetch('/data?page=https://shopping.naturaldos.com/advtr-hemp-softgel-news--5e333&platform=clickfunnels')
      .then(response => response.json())
      .then(data => {
        document.body.innerHTML = document.body.innerHTML.replace(/\${(.*?)}/g, (_, expr) => eval(expr));
      })
      .catch(error => console.error('Error fetching data:', error));
  </script>
</body>
</html>
